<!-- ⭐ DASHBOARD HEALTHSIM COMPLETO -->
<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>HealthSim Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>

*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:Inter;
}

body{
background:#f5f6fa;
color:#333;
}

nav{
background:white;
padding:18px 40px;
display:flex;
justify-content:space-between;
align-items:center;
box-shadow:0 2px 10px rgba(0,0,0,.05);
}

.logo img{
width:250px;
height:80px;
object-fit:contain;
}

.nav-right{
display:flex;
align-items:center;
gap:15px;
}

.logout{
background:#0F4C75;
color:white;
border:none;
padding:8px 16px;
border-radius:6px;
cursor:pointer;
font-weight:600;
}

.container{
max-width:1200px;
margin:auto;
padding:40px 20px;
}

.card{
background:white;
padding:25px;
border-radius:12px;
box-shadow:0 4px 15px rgba(0,0,0,.05);
margin-bottom:30px;
}

.grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:20px;
}

input{
width:100%;
padding:12px;
border-radius:6px;
border:1px solid #ccc;
margin-top:10px;
}

button{
width:100%;
padding:12px;
border:none;
border-radius:6px;
cursor:pointer;
margin-top:15px;
font-weight:600;
}

.primary-btn{
background:#0F4C75;
color:white;
}

.delete-btn{
background:#dc3545;
color:white;
}

.history-item{
background:#fff;
padding:20px;
border-radius:12px;
box-shadow:0 4px 10px rgba(0,0,0,.05);
margin-bottom:15px;
}

.modal{
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,.4);
justify-content:center;
align-items:center;
}

.modal-content{
background:white;
padding:30px;
border-radius:12px;
width:90%;
max-width:400px;
}

.close-btn{
background:#ccc;
color:#333;
}

.chart-wrapper{
	max-width:700px;
	margin:20px auto;
}

#graficoSIR{
	width:100%;
	height:300px;
	display:block;
}

</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<script>
let currentUser=JSON.parse(localStorage.getItem("currentUser"));
if(!currentUser) location.href="login.html";
</script>

<nav>

<div class="logo">
<img src="Imagens/logo.png" alt="Medcei">
</div>

<div class="nav-right">
<span id="userName" style="cursor:pointer;font-weight:600" onclick="abrirPerfil()"></span>
<button class="logout" onclick="logout()">Logout</button>
</div>

</nav>

<div class="container">

<div class="card">
<h2>Bem-vindo, <span id="welcomeName"></span></h2>
<p>Simulação Epidemiológica Inteligente</p>
</div>

<!-- STATS -->
<div class="grid">

<div class="card">
<h3>Total Simulações</h3>
<p id="totalSim">0</p>
</div>

<div class="card">
<h3>Última Simulação</h3>
<p id="ultimaSim">-</p>
</div>

</div>

<!-- SIR GESTOR -->
<div id="sirSection" class="card">

<h2>Simulação SIR (Gestor)</h2>

<input id="popTotal" placeholder="População Total">
<input id="infInicial" placeholder="Infetados Iniciais">
<input id="beta" placeholder="Taxa β">
<input id="gamma" placeholder="Taxa γ">
<input id="duracao" placeholder="Duração (dias)">

<button class="primary-btn" onclick="executarSimulacao()">
Executar Simulação
</button>

<div id="resultadoSimulacao"></div>

</div>

<!-- SIMULADOR CLIENTE -->
<div id="diseaseSim" class="card">

<h2>Simulador de Doença</h2>

<input id="doencaInput" placeholder="Digite a doença (ex: cancro)">

<button class="primary-btn" onclick="simularDoenca()">
Simular Diagnóstico
</button>

<div id="diagnosticoResultado"></div>

</div>

<!-- HISTÓRICO -->
<div class="card">

<h2>Histórico</h2>
<div id="historico"></div>

</div>

</div>

<div id="resultadoSimulacao"></div>
<div class="chart-wrapper">
	<canvas id="graficoSIR"></canvas>
</div>

<!-- PERFIL MODAL -->
<div id="perfilModal" class="modal">

<div class="modal-content">

<h2>Editar Perfil</h2>

<input id="editName" placeholder="Nome">
<input id="editEmail" placeholder="Email">
<input id="editPassword" type="password" placeholder="Nova Password">

<button class="primary-btn" onclick="guardarPerfil()">
Guardar
</button>

<button class="close-btn" onclick="fecharPerfil()">
Cancelar
</button>

<div id="perfilMsg" style="margin-top:10px;font-size:14px"></div>

</div>
</div>

<script>

/* USER INIT */

userName.innerText=currentUser.name+" ("+currentUser.type+")";
welcomeName.innerText=currentUser.name;

/* ROLE CONTROL */

if(currentUser.type==="cliente"){
sirSection.style.display="none";
}else{
diseaseSim.style.display="none";
}

/* STORAGE */

function getDoencas(){
return JSON.parse(localStorage.getItem("doencas"))||[];
}

function saveDoencas(d){
localStorage.setItem("doencas",JSON.stringify(d));
}

/* MOTOR SIR */

function binomial(n,p){
let s=0;
for(let i=0;i<n;i++){
if(Math.random()<p) s++;
}
return s;
}

function motorSIR(pop,inf,beta,gamma,dias){

let S=pop-inf;
let I=inf;
let R=0;

let hist=[];

for(let t=0;t<dias;t++){

if(I<=0) break;

let novosInf=binomial(S,1-Math.exp(-beta*I/pop));
let novosRec=binomial(I,1-Math.exp(-gamma));

S-=novosInf;
I+=novosInf-novosRec;
R+=novosRec;

let Rt=(beta/gamma)*(S/pop);

hist.push({
dia:t,S,I,R,
Rt:Rt.toFixed(2)
});
}

return hist;
}

/* EXEC SIR */

function executarSimulacao(){
	const popTotalEl = document.getElementById('popTotal');
	const infInicialEl = document.getElementById('infInicial');
	const betaEl = document.getElementById('beta');
	const gammaEl = document.getElementById('gamma');
	const duracaoEl = document.getElementById('duracao');
	const resultadoEl = document.getElementById('resultadoSimulacao');

	const pop = parseInt(popTotalEl.value, 10);
	const inf = parseInt(infInicialEl.value, 10);
	const betaVal = parseFloat(betaEl.value);
	const gammaVal = parseFloat(gammaEl.value);
	const dias = parseInt(duracaoEl.value, 10);

	if (!pop || !inf || Number.isNaN(betaVal) || Number.isNaN(gammaVal) || !dias) {
		alert('Preencha todos os parâmetros corretamente');
		return;
	}

	const resultado = motorSIR(pop, inf, betaVal, gammaVal, dias);

	resultadoEl.innerHTML = '';

	resultado.forEach(d => {
		const div = document.createElement('div');
		div.style.fontSize = '14px';
		div.innerText = `Dia ${d.dia} | S:${d.S} I:${d.I} R:${d.R} Rt:${d.Rt}`;
		resultadoEl.appendChild(div);
	});

	/* guardar simulação */
	const d = getDoencas();

	d.push({
		id: Date.now(),
		email: currentUser.email,
		name: currentUser.name,
		disease: 'SIR Simulation',
		status: 'ativo',
		date: new Date().toLocaleString()
	});

	saveDoencas(d);
	carregarHistorico();

	// Atualiza o gráfico com os dados da simulação
	desenharGraficoSIR(resultado);
}

/* SIMULADOR CLIENTE */

function simularDoenca(){

let nome=doencaInput.value.trim();
if(!nome){
alert("Digite a doença");
return;
}

let prob=Math.random();
let resultado=prob>0.6 ? "Possível positivo" : "Negativo";

diagnosticoResultado.innerHTML=
`Resultado para ${nome}: <b>${resultado}</b>`;

/* guardar */

let d=getDoencas();

d.push({
id:Date.now(),
email:currentUser.email,
name:currentUser.name,
disease:nome,
status:resultado,
date:new Date().toLocaleString()
});

saveDoencas(d);
carregarHistorico();
}

/* HISTÓRICO */

function eliminarDoenca(id){

let d=getDoencas().filter(x=>x.id!==id);
saveDoencas(d);
carregarHistorico();
}

function carregarHistorico(){

let historicoDiv=document.getElementById("historico");
historicoDiv.innerHTML="";

let doencas=getDoencas();

let lista=currentUser.type==="gestor"
? doencas
: doencas.filter(x=>x.email===currentUser.email);

totalSim.innerText=lista.length;

ultimaSim.innerText=lista.length
? lista[lista.length-1].date
: "-";

lista.forEach(item=>{

let card=document.createElement("div");
card.className="history-item";

let nomePaciente="";

if(currentUser.type==="gestor"){
nomePaciente=`<strong>Paciente:</strong> ${item.name || item.email}<br>`;
}

card.innerHTML=`
${nomePaciente}
<strong>Doença:</strong> ${item.disease}<br>
<small>${item.date}</small><br>
Status: ${item.status}
`;

if(currentUser.type==="gestor"){
card.innerHTML+=`
<button class="delete-btn" onclick="eliminarDoenca(${item.id})">
Eliminar doença
</button>`;
}

historicoDiv.appendChild(card);

});
}

/* PERFIL */

function abrirPerfil(){
editName.value=currentUser.name;
editEmail.value=currentUser.email;
editPassword.value="";
perfilModal.style.display="flex";
}

function fecharPerfil(){
perfilModal.style.display="none";
perfilMsg.innerHTML="";
}

function guardarPerfil(){

let novoNome=editName.value.trim();
let novoEmail=editEmail.value.trim();
let novaPass=editPassword.value.trim();

if(!novoNome||!novoEmail){
perfilMsg.innerHTML="<span style='color:red'>Nome e Email obrigatórios</span>";
return;
}

let sims=getDoencas();

sims.forEach(s=>{
if(s.email===currentUser.email){
s.email=novoEmail;
}
});

saveDoencas(sims);

let atualizado={
...currentUser,
name:novoNome,
email:novoEmail,
pass:novaPass||currentUser.pass
};

localStorage.setItem(novoEmail,JSON.stringify(atualizado));
localStorage.setItem("currentUser",JSON.stringify(atualizado));

currentUser=atualizado;

userName.innerText=currentUser.name+" ("+currentUser.type+")";
welcomeName.innerText=currentUser.name;

perfilMsg.innerHTML="<span style='color:green'>Perfil atualizado!</span>";

setTimeout(()=>{
fecharPerfil();
carregarHistorico();
},1200);
}

/* LOGOUT */

function logout(){
localStorage.removeItem("currentUser");
location.href="login.html";
}

function desenharGraficoSIR(dados){

if(!Array.isArray(dados)) dados = [];

let ctx=document.getElementById("graficoSIR").getContext("2d");

let labels = dados.length ? dados.map(x=>"Dia "+x.dia) : [];

let S = dados.length ? dados.map(x=>x.S) : [];
let I = dados.length ? dados.map(x=>x.I) : [];
let R = dados.length ? dados.map(x=>x.R) : [];

if(window.graficoSIRInstance){
window.graficoSIRInstance.destroy();
}

window.graficoSIRInstance=new Chart(ctx,{
type:"line",
data:{
labels:labels,
datasets:[
{
label:"Suscetíveis",
data:S,
borderColor:'#0F4C75',
backgroundColor:'rgba(15,76,117,0.08)',
fill:true,
tension:0.3
},
{
label:"Infetados",
data:I,
borderColor:'#dc3545',
backgroundColor:'rgba(220,53,69,0.08)',
fill:true,
tension:0.3
},
{
label:"Recuperados",
data:R,
borderColor:'#28a745',
backgroundColor:'rgba(40,167,69,0.08)',
fill:true,
tension:0.3
}
]
},
options:{
responsive:true,
scales:{
y:{beginAtZero:true}
}
}
});

}

carregarHistorico();
desenharGraficoSIR([]);

</script>

</body>
</html>